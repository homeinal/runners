generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Race {
  id                  String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title               String
  eventStartAt        DateTime                 @map("event_start_at") @db.Timestamptz(6)
  eventTimezone       String                   @default("Asia/Seoul") @map("event_timezone")
  eventTimeRaw        String?                  @map("event_time_raw")
  country             String
  region              String?
  venue               String?
  registrationStatus  registration_status_enum @default(unknown) @map("registration_status")
  registrationStartAt DateTime?                @map("registration_start_at") @db.Timestamptz(6)
  registrationEndAt   DateTime?                @map("registration_end_at") @db.Timestamptz(6)
  categoriesRaw       String[]                 @map("categories_raw")
  organizer           String
  organizerRep        String?                  @map("organizer_rep")
  phone               String?
  email               String?
  website             String?
  imageUrl            String?                  @map("image_url")
  isFeatured          Boolean                  @default(false) @map("is_featured")
  isUrgent            Boolean                  @default(false) @map("is_urgent")
  createdAt           DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  sourceUrl           String?                  @map("source_url")
  categories          RaceEventCategory[]

  @@index([categoriesRaw], map: "idx_races_categories_raw_gin", type: Gin)
  @@index([country, region, eventStartAt], map: "idx_races_country_region_event")
  @@index([createdAt], map: "idx_races_created_at")
  @@index([eventStartAt], map: "idx_races_event_start_at")
  @@index([region, eventStartAt], map: "idx_races_region_event_start_at")
  @@index([region(ops: raw("gin_trgm_ops"))], map: "idx_races_region_trgm", type: Gin)
  @@index([registrationStartAt], map: "idx_races_registration_start_at")
  @@index([registrationStatus], map: "idx_races_registration_status")
  @@index([title(ops: raw("gin_trgm_ops"))], map: "idx_races_title_trgm", type: Gin)
  @@index([venue(ops: raw("gin_trgm_ops"))], map: "idx_races_venue_trgm", type: Gin)
  @@map("races")
}

model RaceEventCategory {
  id            String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  raceId        String                  @map("race_id") @db.Uuid
  rawName       String                  @map("raw_name")
  canonicalName String                  @map("canonical_name")
  distanceKm    Decimal?                @map("distance_km") @db.Decimal
  type          race_category_type_enum
  tags          String[]                @default([]) @map("tags")
  createdAt     DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  race          Race                    @relation(fields: [raceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([raceId, rawName], map: "uq_rec_race_raw")
  @@index([canonicalName(ops: raw("gin_trgm_ops"))], map: "idx_rec_canonical_name_trgm", type: Gin)
  @@index([distanceKm], map: "idx_rec_distance")
  @@index([raceId], map: "idx_rec_race_id")
  @@index([raceId, createdAt], map: "idx_rec_race_id_created_at")
  @@index([rawName(ops: raw("gin_trgm_ops"))], map: "idx_rec_raw_name_trgm", type: Gin)
  @@index([tags], map: "idx_rec_tags_gin", type: Gin)
  @@index([type], map: "idx_rec_type")
  @@map("race_event_categories")
}

model Post {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug          String           @unique(map: "uq_posts_slug")
  title         String
  excerpt       String?
  contentMd     String           @map("content_md")
  coverImageUrl String?          @map("cover_image_url")
  status        post_status_enum @default(draft)
  publishedAt   DateTime?        @map("published_at") @db.Timestamptz(6)
  authorId      String?          @map("author_id") @db.Uuid
  createdAt     DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime         @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@index([createdAt(sort: Desc)], map: "idx_posts_created_at")
  @@index([slug(ops: raw("gin_trgm_ops"))], map: "idx_posts_slug_trgm", type: Gin)
  @@index([status, publishedAt(sort: Desc)], map: "idx_posts_status_published_at")
  @@index([title(ops: raw("gin_trgm_ops"))], map: "idx_posts_title_trgm", type: Gin)
  @@map("posts")
}

// ─── NextAuth Models ───────────────────────────────────────

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String        @unique
  emailVerified DateTime?     @map("email_verified")
  image         String?
  accounts      Account[]
  sessions      Session[]
  runRecords    RunRecord[]
  crewProfile   CrewProfile?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─── Crew Profiles ────────────────────────────────────────

model CrewProfile {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nickname      String
  region        String
  pace          String
  message       String?
  tags          String[] @default([])
  availableDays String[] @default([]) @map("available_days")
  preferredTime String?  @map("preferred_time")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([region], map: "idx_crew_profiles_region")
  @@index([createdAt], map: "idx_crew_profiles_created_at")
  @@map("crew_profiles")
}

// ─── Running Records ──────────────────────────────────────

model RunRecord {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  distanceKm      Float    @map("distance_km")
  paceSeconds     Int      @map("pace_seconds")
  durationSeconds Int      @map("duration_seconds")
  calories        Int?
  screenshotUrl   String   @map("screenshot_url")
  rawOcrText      String?  @map("raw_ocr_text") @db.Text
  runDate         DateTime @map("run_date") @db.Date
  isVerified      Boolean  @default(false) @map("is_verified")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([runDate], map: "idx_run_records_run_date")
  @@index([userId, runDate], map: "idx_run_records_user_date")
  @@index([runDate, distanceKm], map: "idx_run_records_date_distance")
  @@index([runDate, paceSeconds], map: "idx_run_records_date_pace")
  @@map("run_records")
}

// ─── Enums ────────────────────────────────────────────────

enum post_status_enum {
  draft
  published
  archived
}

enum race_category_type_enum {
  event
  walk
  team
  para
  trail
  race
  other
}

enum registration_status_enum {
  open
  closed
  unknown
}
