generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Registration status
enum RegistrationStatus {
  open
  closed
  unknown
}

// Race category type
enum RaceCategoryType {
  event
  walk
  team
  para
  trail
  race
  other
}

model Race {
  id    String @id @default(uuid()) @db.Uuid
  title String

  // Source
  sourceUrl String? @unique @map("source_url")

  // Date & Time
  eventStartAt DateTime @map("event_start_at") @db.Timestamptz(6)
  eventTimezone String @default("Asia/Seoul") @map("event_timezone")
  eventTimeRaw String? @map("event_time_raw")

  // Location
  country String
  region  String?
  venue   String?

  // Registration
  registrationStatus RegistrationStatus @default(unknown) @map("registration_status")
  registrationStartAt DateTime? @map("registration_start_at") @db.Timestamptz(6)
  registrationEndAt DateTime? @map("registration_end_at") @db.Timestamptz(6)

  // Raw category cache
  categoriesRaw String[] @map("categories_raw")

  // Organizer
  organizer    String
  organizerRep String? @map("organizer_rep")

  // Contact
  phone   String?
  email   String?
  website String?

  // Images
  imageUrl String? @map("image_url")

  // Features
  isFeatured Boolean @default(false) @map("is_featured")
  isUrgent   Boolean @default(false) @map("is_urgent")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  categories RaceEventCategory[]

  @@index([eventStartAt])
  @@index([country, region, eventStartAt])
  @@index([registrationStatus])
  @@index([createdAt])
  @@index([isFeatured])
  @@index([isUrgent])
  @@map("races")
}

model RaceEventCategory {
  id     String @id @default(uuid()) @db.Uuid
  raceId String @map("race_id") @db.Uuid
  race   Race   @relation(fields: [raceId], references: [id], onDelete: Cascade)

  rawName       String @map("raw_name")
  canonicalName String @map("canonical_name")
  distanceKm    Decimal? @map("distance_km")
  type          RaceCategoryType
  tags          String[] @default([]) @map("tags")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([raceId, rawName])
  @@index([raceId])
  @@index([type])
  @@index([distanceKm])
  @@map("race_event_categories")
}
